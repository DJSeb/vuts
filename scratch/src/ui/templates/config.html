{% extends "base.html" %}

{% block title %}Configuration - VUTS{% endblock %}

{% block content %}
<div class="page-header">
    <h2>‚öôÔ∏è Configuration & Management</h2>
    <p class="subtitle">Manage system settings and data sources</p>
</div>

<div class="config-container">
    <section class="config-section">
        <h3>üìä Current Configuration</h3>
        {% if config %}
        <div class="config-display">
            <div class="config-item">
                <label>Topics to Monitor:</label>
                <div class="config-value">
                    {% for topic in config.topics %}
                    <span class="badge neutral">{{ topic }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="config-item">
                <label>News Sources:</label>
                <div class="config-value">
                    {% for source in config.sources %}
                    <span class="badge neutral">{{ source }}</span>
                    {% endfor %}
                </div>
            </div>

            <div class="config-item">
                <label>Max Article Age:</label>
                <div class="config-value">{{ config.max_age_days }} days</div>
            </div>

            <div class="config-item">
                <label>Fetch Full Content:</label>
                <div class="config-value">{{ "Yes" if config.fetch_full_content else "No" }}</div>
            </div>

            {% if config.fetch_full_content %}
            <div class="config-item">
                <label>Full Content Top N:</label>
                <div class="config-value">{{ config.fetch_full_top_n }} articles</div>
            </div>
            {% endif %}

            <div class="config-item">
                <label>Content Extractor:</label>
                <div class="config-value">{{ config.content_extractor }}</div>
            </div>

            <div class="config-item">
                <label>Max Content Length:</label>
                <div class="config-value">{{ config.max_content_chars }} characters</div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <p>No configuration file found. Using default settings.</p>
            <p>Create a configuration file at <code>scratch/config.json</code> or use <code>scratch/example_data/copilot-gpt5-cfg.json</code> as a template.</p>
        </div>
        {% endif %}
    </section>

    <section class="config-section">
        <h3>üìÅ Data Management</h3>
        <div class="config-display">
            <div class="config-item">
                <label>Data Directory:</label>
                <div class="config-value"><code>{{ data_dir }}</code></div>
            </div>

            <div class="config-item">
                <label>Available Topics:</label>
                <div class="config-value">
                    {% if available_topics %}
                    {% for topic in available_topics %}
                    <span class="badge neutral">{{ topic }}</span>
                    {% endfor %}
                    {% else %}
                    <span class="text-muted">No topics analyzed yet</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <section class="config-section">
        <h3>‚ñ∂Ô∏è Execute Commands</h3>
        <p class="subtitle">Run vuts commands directly from the UI</p>
        
        <div class="execution-forms">
            <!-- Fetch Command Form -->
            <div class="execution-card">
                <h4>1. Fetch News Articles</h4>
                <form id="fetch-form" class="execution-form">
                    <div class="form-group">
                        <label for="fetch-config">Configuration File:</label>
                        <input type="text" id="fetch-config" name="config" 
                               value="example_data/copilot-gpt5-cfg.json" required>
                        <small>Path relative to scratch directory</small>
                    </div>
                    <div class="form-group">
                        <label for="fetch-output">Output Directory:</label>
                        <input type="text" id="fetch-output" name="output_dir" 
                               value="output" required>
                        <small>Directory where articles will be saved</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Fetch Articles</span>
                        <span class="btn-loading" style="display:none;">‚è≥ Running...</span>
                    </button>
                </form>
                <div id="fetch-output-display" class="output-display" style="display:none;">
                    <h5>Output:</h5>
                    <pre class="output-content"></pre>
                </div>
            </div>

            <!-- Market Command Form -->
            <div class="execution-card">
                <h4>2. Fetch Market Data</h4>
                <form id="market-form" class="execution-form">
                    <div class="form-group">
                        <label for="market-symbols">Stock Symbols:</label>
                        <input type="text" id="market-symbols" name="symbols" 
                               value="TSLA MSFT NVIDIA AMD" required>
                        <small>Space or comma separated (e.g., TSLA, MSFT, NVIDIA)</small>
                    </div>
                    <div class="form-group">
                        <label for="market-days">Days of History:</label>
                        <input type="number" id="market-days" name="days" 
                               value="30" min="1" max="365" required>
                        <small>Number of days of historical data (1-365)</small>
                    </div>
                    <div class="form-group">
                        <label for="market-output">Output Directory:</label>
                        <input type="text" id="market-output" name="output_dir" 
                               value="output/market_data" required>
                        <small>Directory where market data will be saved</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Fetch Market Data</span>
                        <span class="btn-loading" style="display:none;">‚è≥ Running...</span>
                    </button>
                </form>
                <div id="market-output-display" class="output-display" style="display:none;">
                    <h5>Output:</h5>
                    <pre class="output-content"></pre>
                </div>
            </div>

            <!-- Analyze Command Form -->
            <div class="execution-card">
                <h4>3. Analyze Sentiment</h4>
                <form id="analyze-form" class="execution-form">
                    <div class="form-group">
                        <label for="analyze-data-dir">Data Directory:</label>
                        <input type="text" id="analyze-data-dir" name="data_dir" 
                               value="output" required>
                        <small>Directory containing fetched articles</small>
                    </div>
                    <div class="form-group">
                        <label for="analyze-max-articles">Max Articles:</label>
                        <input type="number" id="analyze-max-articles" name="max_articles" 
                               value="10" min="1" required>
                        <small>Maximum number of articles to analyze</small>
                    </div>
                    <div class="form-group">
                        <label for="analyze-model">LLM Model:</label>
                        <select id="analyze-model" name="model" required>
                            <option value="gpt-4o-mini" selected>gpt-4o-mini (recommended)</option>
                            <option value="gpt-4o">gpt-4o</option>
                            <option value="gpt-4">gpt-4</option>
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                        </select>
                        <small>OpenAI model to use for analysis</small>
                    </div>
                    <div class="form-group">
                        <label for="analyze-market-data">Market Data Directory (Optional):</label>
                        <input type="text" id="analyze-market-data" name="market_data_dir" 
                               value="output/market_data">
                        <small>Leave empty if no market data available</small>
                    </div>
                    <div class="alert alert-warning">
                        ‚ö†Ô∏è Requires <code>OPENAI_API_KEY</code> environment variable
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Analyze Sentiment</span>
                        <span class="btn-loading" style="display:none;">‚è≥ Running...</span>
                    </button>
                </form>
                <div id="analyze-output-display" class="output-display" style="display:none;">
                    <h5>Output:</h5>
                    <pre class="output-content"></pre>
                </div>
            </div>
        </div>
    </section>

    <section class="config-section">
        <h3>üîß Workflow Commands (CLI Reference)</h3>
        <div class="workflow-commands">
            <div class="command-card">
                <h4>1. Fetch News Articles</h4>
                <pre><code>cd scratch
python src/fetching/financial_news_collector_async.py \
    example_data/copilot-gpt5-cfg.json output</code></pre>
                <p class="command-description">Fetches news articles from configured sources for specified topics.</p>
            </div>

            <div class="command-card">
                <h4>2. Fetch Market Data (Optional)</h4>
                <pre><code>cd scratch
python src/market/data_fetcher.py TSLA MSFT NVIDIA AMD \
    --output-dir output/market_data</code></pre>
                <p class="command-description">Fetches historical market data to provide context for sentiment analysis.</p>
            </div>

            <div class="command-card">
                <h4>3. Analyze Sentiment</h4>
                <pre><code>cd scratch
python src/llm/sentiment_analyzer.py \
    --data-dir output \
    --max-articles 10 \
    --market-data-dir output/market_data</code></pre>
                <p class="command-description">Analyzes sentiment of collected articles using LLM.</p>
                <div class="alert alert-warning">
                    ‚ö†Ô∏è Requires <code>OPENAI_API_KEY</code> environment variable
                </div>
            </div>

            <div class="command-card">
                <h4>Quick Demo (No API Keys)</h4>
                <pre><code>cd scratch
python demo_workflow.py</code></pre>
                <p class="command-description">Runs a complete demo with mock data - no API keys required.</p>
            </div>
        </div>
    </section>

    <section class="config-section">
        <h3>üîë API Configuration</h3>
        <div class="api-config">
            <div class="alert alert-info">
                <h4>Required API Keys</h4>
                <p>Set these environment variables before running the analysis:</p>
                <ul>
                    <li><strong>OPENAI_API_KEY</strong> - Required for sentiment analysis (OpenAI GPT models)</li>
                </ul>
                
                <h4>Optional API Keys</h4>
                <ul>
                    <li><strong>NEWSAPI_KEY</strong> - For NewsAPI.org news fetching</li>
                    <li><strong>BING_NEWS_KEY</strong> - For Bing News API</li>
                    <li><strong>FINNHUB_KEY</strong> - For Finnhub financial news</li>
                </ul>
                
                <p class="text-muted">Note: Some news sources (like Google News RSS) don't require API keys.</p>
            </div>
        </div>
    </section>

    <section class="config-section">
        <h3>üìù Configuration File Format</h3>
        <div class="config-template">
            <p>Create a JSON configuration file with the following structure:</p>
            <pre><code>{
  "topics": ["TSLA", "MSFT", "NVIDIA", "AMD"],
  "sources": ["googlenews_rss", "bingnews", "finnhub"],
  "max_age_days": 14,
  "fetch_full_content": true,
  "fetch_full_top_n": 5,
  "content_extractor": "readability",
  "max_content_chars": 6000
}</code></pre>
        </div>
    </section>
</div>

<script>
// Handle form submissions for command execution
document.addEventListener('DOMContentLoaded', function() {
    const forms = {
        'fetch': document.getElementById('fetch-form'),
        'market': document.getElementById('market-form'),
        'analyze': document.getElementById('analyze-form')
    };

    Object.keys(forms).forEach(command => {
        const form = forms[command];
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = form.querySelector('button[type="submit"]');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            const outputDisplay = document.getElementById(`${command}-output-display`);
            const outputContent = outputDisplay.querySelector('.output-content');
            
            // Disable button and show loading
            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';
            
            // Clear previous output
            outputDisplay.style.display = 'none';
            outputContent.textContent = '';
            
            // Collect form data
            const formData = new FormData(form);
            const args = {};
            for (const [key, value] of formData.entries()) {
                args[key] = value;
            }
            
            try {
                // Send request to execute command
                const response = await fetch('/api/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: command,
                        args: args
                    })
                });
                
                const result = await response.json();
                
                // Display output
                outputDisplay.style.display = 'block';
                
                if (result.success) {
                    outputContent.textContent = result.output || 'Command completed successfully!';
                    outputDisplay.classList.remove('output-error');
                    outputDisplay.classList.add('output-success');
                } else {
                    const errorText = result.error || result.output || 'Unknown error occurred';
                    outputContent.textContent = `Error: ${errorText}`;
                    outputDisplay.classList.remove('output-success');
                    outputDisplay.classList.add('output-error');
                }
            } catch (error) {
                // Display error
                outputDisplay.style.display = 'block';
                outputContent.textContent = `Error: ${error.message}`;
                outputDisplay.classList.remove('output-success');
                outputDisplay.classList.add('output-error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        });
    });
});
</script>

{% endblock %}
